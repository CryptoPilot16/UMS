<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Underground Money Society</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üçÑ</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: black; font-family: 'Courier New', Courier, monospace; color: #ddd; }
    #scene { position: absolute; width: 100vw; height: 100vh; z-index: 1; }
    #scene video, #scene-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; pointer-events: none; }
    .darken { filter: brightness(0.55); }

    .hotspot { position: absolute; width: 20px; height: 20px; border-radius: 50%; background: #fff; opacity: 0.6; z-index: 3; pointer-events: auto; transition: opacity 0.2s ease; border: none; }
    .hotspot:hover { animation: pulse 800ms infinite alternate ease-in-out; opacity: 1; }
    @keyframes pulse { from { box-shadow: 0 0 0 0 rgba(255,255,255,0.0); } to { box-shadow: 0 0 14px 2px rgba(255,255,255,0.9); } }
    .hotspot::after { content: attr(data-label); position: absolute; left: 50%; top: -10px; transform: translate(-50%, -100%) scale(1); white-space: nowrap; background: rgba(0,0,0,0.8); color: #e6ffe6; font-size: 12px; padding: 6px 8px; border-radius: 6px; opacity: 0; pointer-events: none; transition: opacity .12s ease, transform .12s ease; }
    .hotspot:hover::after { opacity: 1; transform: translate(-50%, -100%) scale(1.05); }

    #ui { position: absolute; top: 20px; left: 20px; z-index: 4; }
    .btn { padding: 8px 16px; font-size: 1em; background: rgba(255,255,255,0.1); border: 1px solid #888; color: white; cursor: pointer; margin: 6px; transition: 0.3s; }
    .btn:hover { background: rgba(255,255,255,0.3); }

    #dialogue { position: absolute; bottom: 30px; width: 100%; text-align: center; font-size: 1.2em; background: rgba(0,0,0,0.5); padding: 10px; z-index: 2; }

    /* Popup modal (Lore video) */
    #popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;               /* toggled to flex when opened */
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 0;                  /* removed padding so video fills screen */
    }

    #popup video {
      width: 100%;
      height: 100%;
      object-fit: contain;         /* change to 'cover' if you want fill/crop */
      box-shadow: none;
      outline: none;
      background: black;
      transform: scale(0.98);
      opacity: 0;
      transition: transform .18s ease-out, opacity .18s ease-out;
    }

    /* When showing, smoothly zoom in and fade in the video */
    #popup.show video {
      transform: scale(1);
      opacity: 1;
    }

    #closeBtn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      z-index: 11;
      line-height: 1;
      padding: 6px 8px;
    }
    #closeBtn:hover { color: red; }

    /* Scene 3 ‚Äî mobile landscape rotation (unchanged) */
    @media (max-width: 768px) and (orientation: landscape) {
      #scene-image.scene3-mobile {
        background: url('scene3-vertical.png') center/contain no-repeat !important;
        transform: rotate(90deg);
        transform-origin: center center;
      }
      .hotspot.mobile-scene3 {
        transform: rotate(-90deg);
      }
      #ui { top: auto; bottom: 20px; left: 20px; }
    }

    /* Scene 3 ‚Äî mobile portrait panorama stage */
    .pan-stage {
      position: absolute;
      inset: 0;
      overflow: hidden;          /* we handle panning via transform */
      touch-action: pan-y;       /* allow vertical gestures to scroll page if needed, we handle x */
    }
    .pan-surface {
      position: absolute;
      top: 0; left: 0;
      height: 100%;
      width: 200vw;              /* 2x viewport width to allow sliding; tweak as needed */
      will-change: transform;
    }
    .pan-surface #scene-image {
      position: absolute;
      top: 0; left: 0;
      width: 100%;               /* matches surface width */
      height: 100%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    /* Hotspots inside pan-surface move with the image */
    .pan-surface .hotspot { pointer-events: auto; }
  </style>
</head>
<body>
  <div id="scene"></div>

  <div id="ui">
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <button class="btn" onclick="advanceScene()">advance</button>
      <button class="btn" onclick="toggleAudio()">audio</button>
    </div>
  </div>

  <div id="dialogue">Private! Get ready. We're entering Sector 4.</div>

  <audio id="radio" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" autoplay loop></audio>

  <!-- Popup modal -->
  <div id="popup" onclick="closePopup(event)">
    <button id="closeBtn" onclick="closePopup(event)" aria-label="Close video">‚úï</button>
    <video id="popupVideo" controls playsinline></video>
  </div>

  <script>
    const DEFAULT_LABELS = ['Twitter','Chart','Telegram','Community','Lore'];
    const HOTSPOT_LINKS = {
      'Twitter': 'https://x.com/UMSonSOL',
      'Chart': 'https://dexscreener.com/solana/ct9g9gddxwnvagvkjq9xoejvynpipr7uxx4akp6g8mhv',
      'Telegram': 'https://t.me/undergroundmoneysocietymemes',
      'Community': 'https://x.com/i/communities/1952904167753957408',
      'Lore': 'popup'
    };

    let scenes = [
      { background: 'scene1.mp4', type: 'video', class: 'darken', text: 'Get ready. You\'re entering the Underground Money Society.' },
      { background: 'scene2.mp4', type: 'video', class: 'darken', text: 'The hardest degens of the Solana trenches' },
      { background: 'scene3.png', type: 'image', class: '', text: 'Wake up, join the underground: 9Z4EZGiirqkjE2Mfnb4xmJebxxqZZugTwewVRfo8bonk', labels: DEFAULT_LABELS, hotspots: getHotspots() }
    ];
    let currentScene = 0;

    // AUDIO STATE SNAPSHOT (so we can restore after Lore finishes/closes)
    let _audioWasPlaying = false;

    // Panorama state (for Scene 3 mobile portrait)
    const PAN_SCALE = 2; // 2x viewport width
    let pan = {
      active: false,
      x: 0, startX: 0, dragging: false,
      minX: 0, maxX: 0,
      surfaceEl: null, stageEl: null,
      tiltEnabled: false, tiltRAF: null, tiltTargetX: 0
    };

    function isMobileLandscape() {
      return window.innerWidth <= 768 && window.matchMedia('(orientation: landscape)').matches;
    }
    function isMobilePortrait() {
      return window.innerWidth <= 768 && window.matchMedia('(orientation: portrait)').matches;
    }

    function getHotspots() {
      if (isMobileLandscape()) {
        return [
          { x: '60%', y: '18%' },  // screen 1
          { x: '74%', y: '20%' },  // screen 2
          { x: '98%', y: '40%' },  // far-right headphones
          { x: '44%', y: '40%' },  // chair
          { x: '12%', y: '25%' }   // coffee
        ];
      }
      return [
        { x: '55%', y: '23%' },    // screen 1
        { x: '69%', y: '25%' },    // screen 2
        { x: '95%', y: '45%' },    // far-right headphones
        { x: '39%', y: '45%' },    // chair
        { x: '8%',  y: '30%' }     // coffee
      ];
    }

    function advanceScene() {
      currentScene++;
      if (currentScene >= scenes.length) currentScene = 0;
      updateScene();
    }

    function updateScene() {
      teardownPanorama(); // in case we were in Scene 3 portrait previously

      const sceneContainer = document.getElementById('scene');
      sceneContainer.innerHTML = '';
      const current = scenes[currentScene];

      const isScene3 = current.background.includes('scene3');
      const rotateForMobile = isScene3 && isMobileLandscape();
      const panForMobile = isScene3 && isMobilePortrait();

      if (rotateForMobile) {
        current.hotspots = getHotspots();
        current.class = (current.class + ' scene3-mobile').trim();
      }

      // RENDER: Scene types
      if (current.type === 'video') {
        const video = document.createElement('video');
        video.src = current.background;
        video.autoplay = true;
        video.loop = true;
        video.muted = true;
        video.playsInline = true;
        if (current.class) video.className = current.class;
        sceneContainer.appendChild(video);
      } else if (current.type === 'image' && panForMobile) {
        // === Scene 3, Mobile PORTRAIT: Panorama mode (drag + tilt) ===
        const stage = document.createElement('div');
        stage.className = 'pan-stage';
        const surface = document.createElement('div');
        surface.className = 'pan-surface';
        stage.appendChild(surface);

        const img = document.createElement('div');
        img.id = 'scene-image';
        img.style.background = `url('${current.background}') center/cover no-repeat`;
        surface.appendChild(img);

        // Hotspots inside surface (move with image)
        const labels = current.labels || DEFAULT_LABELS;
        current.hotspots = getHotspots();
        if (current.hotspots) {
          current.hotspots.forEach((hs, i) => {
            const dot = document.createElement('div');
            dot.className = 'hotspot';
            dot.style.left = hs.x;
            dot.style.top = hs.y;
            dot.setAttribute('data-label', labels[i] || '');
            dot.onclick = (ev) => { ev.stopPropagation(); handleHotspotClick(labels[i]); };
            surface.appendChild(dot);
          });
        }

        sceneContainer.appendChild(stage);

        // Setup panorama dragging + tilt
        setupPanorama(stage, surface);

      } else if (current.type === 'image') {
        // Default image render (desktop + mobile landscape)
        const img = document.createElement('div');
        img.id = 'scene-image';
        img.style.background = `url('${current.background}') center/cover no-repeat`;
        if (current.class) img.className = current.class;
        sceneContainer.appendChild(img);

        // Hotspots on top of image
        if (current.hotspots) {
          const labels = current.labels || DEFAULT_LABELS;
          current.hotspots.forEach((hs, i) => {
            const dot = document.createElement('div');
            dot.className = 'hotspot';
            if (rotateForMobile) {
              dot.classList.add('mobile-scene3');
            }
            dot.style.left = hs.x;
            dot.style.top = hs.y;
            dot.setAttribute('data-label', labels[i] || '');
            dot.onclick = () => handleHotspotClick(labels[i]);
            sceneContainer.appendChild(dot);
          });
        }
      }

      document.getElementById('dialogue').textContent = current.text;
    }

    // === Panorama (Scene 3 mobile PORTRAIT) ===
    function setupPanorama(stageEl, surfaceEl) {
      pan.active = true;
      pan.stageEl = stageEl;
      pan.surfaceEl = surfaceEl;
      pan.x = 0;
      const stageW = pan.stageEl.clientWidth;
      const surfaceW = stageW * PAN_SCALE; // because .pan-surface is 200vw
      pan.maxX = 0;
      pan.minX = -(surfaceW - stageW);
      applyPan();

      // Touch/drag
      const onTouchStart = (e) => {
        pan.dragging = true;
        const pageX = (e.touches ? e.touches[0].pageX : e.pageX);
        pan.startX = pageX - pan.x;
        // Attempt to enable tilt on first interaction (iOS permission)
        maybeEnableTilt();
      };
      const onTouchMove = (e) => {
        if (!pan.dragging) return;
        const pageX = (e.touches ? e.touches[0].pageX : e.pageX);
        pan.x = clamp(pageX - pan.startX, pan.minX, pan.maxX);
        applyPan();
      };
      const endDrag = () => { pan.dragging = false; };

      stageEl.addEventListener('touchstart', onTouchStart, {passive:true});
      stageEl.addEventListener('touchmove', onTouchMove, {passive:true});
      stageEl.addEventListener('touchend', endDrag);
      stageEl.addEventListener('mousedown', (e)=>{ e.preventDefault(); onTouchStart(e); });
      window.addEventListener('mousemove', onTouchMove);
      window.addEventListener('mouseup', endDrag);

      // Save listeners for teardown
      pan._listeners = [
        ['touchstart', onTouchStart, stageEl],
        ['touchmove', onTouchMove, stageEl],
        ['touchend', endDrag, stageEl],
        ['mousedown', (e)=>{ e.preventDefault(); onTouchStart(e); }, stageEl],
        ['mousemove', onTouchMove, window],
        ['mouseup', endDrag, window],
      ];

      // Tilt
      window.addEventListener('deviceorientation', handleTilt, true);
      pan._listeners.push(['deviceorientation', handleTilt, window]);
      startTiltRAF();
    }

    function teardownPanorama() {
      if (!pan.active) return;
      // Remove listeners
      if (pan._listeners) {
        pan._listeners.forEach(([type, fn, target]) => target.removeEventListener(type, fn));
      }
      window.removeEventListener('deviceorientation', handleTilt, true);
      cancelAnimationFrame(pan.tiltRAF);
      // Reset state
      pan = {
        active: false, x: 0, startX: 0, dragging: false,
        minX: 0, maxX: 0, surfaceEl: null, stageEl: null,
        tiltEnabled: false, tiltRAF: null, tiltTargetX: 0
      };
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function applyPan() {
      if (!pan.surfaceEl) return;
      pan.surfaceEl.style.transform = `translate3d(${pan.x}px, 0, 0)`;
    }

    // Tilt support
    function maybeEnableTilt() {
      if (pan.tiltEnabled) return;
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS requires a user gesture to request permission
        DeviceOrientationEvent.requestPermission().then((res) => {
          if (res === 'granted') pan.tiltEnabled = true;
        }).catch(()=>{ /* ignore */ });
      } else {
        // Android/others usually allow without prompt
        pan.tiltEnabled = true;
      }
    }

    function handleTilt(e) {
      if (!pan.active || !pan.tiltEnabled || pan.dragging) return;
      // gamma: left-right tilt, typically -90..90
      const gamma = e.gamma;
      if (gamma == null) return;
      // Map gamma (-45..45) to pan range (minX..maxX)
      const clamped = Math.max(-45, Math.min(45, gamma));
      const t = (clamped + 45) / 90; // 0..1
      const target = pan.minX + (pan.maxX - pan.minX) * t;
      pan.tiltTargetX = target;
    }

    function startTiltRAF() {
      const tick = () => {
        if (pan.active && pan.tiltEnabled && !pan.dragging) {
          // Smoothly approach tilt target
          pan.x += (pan.tiltTargetX - pan.x) * 0.08;
          pan.x = clamp(pan.x, pan.minX, pan.maxX);
          applyPan();
        }
        pan.tiltRAF = requestAnimationFrame(tick);
      };
      pan.tiltRAF = requestAnimationFrame(tick);
    }

    // ===== Audio restore logic for Lore (unchanged) =====
    function restoreAudio() {
      const audio = document.getElementById('radio');
      if (_audioWasPlaying) {
        audio.play().catch(()=>{});
      } else {
        try { audio.pause(); } catch {}
      }
    }

    function handleHotspotClick(label) {
      const link = HOTSPOT_LINKS[label];
      if (link === 'popup') {
        const popup = document.getElementById('popup');
        const video = document.getElementById('popupVideo');
        const audio = document.getElementById('radio');

        // Snapshot current audio state, then PAUSE music during Lore
        _audioWasPlaying = !audio.paused;
        try { audio.pause(); } catch {}

        // Set video source & show popup
        video.src = 'lore.mp4';
        video.currentTime = 0;

        popup.style.display = 'flex';
        requestAnimationFrame(() => {
          popup.classList.add('show');
          video.play().catch(()=>{ /* ignore autoplay block */ });
        });

        // When Lore ends/unloads, restore music to prior state
        video.onended = () => restoreAudio();
        video.onemptied = () => restoreAudio();
      } else if (link) {
        window.open(link, '_blank');
      }
    }

    function closePopup(e) {
      // Only close when clicking backdrop or the dedicated X button
      const isBackdrop = e && e.currentTarget && e.target === e.currentTarget;
      const isCloseBtn = e && e.target && e.target.id === 'closeBtn';
      if (!isBackdrop && !isCloseBtn) return;

      const popup = document.getElementById('popup');
      const video = document.getElementById('popupVideo');

      try { video.pause(); } catch {}
      popup.classList.remove('show');
      popup.style.display = 'none';

      // Remove source to free memory (triggers onemptied ‚Üí restoreAudio)
      video.removeAttribute('src');
      video.load();

      // Safety: if the empties event misses for any reason, restore now.
      restoreAudio();
    }

    function toggleAudio() {
      const audio = document.getElementById('radio');
      if (audio.paused) { audio.currentTime = 0; audio.play(); } else { audio.pause(); }
    }

    // Recompute scene 3 layout on size/orientation changes
    window.addEventListener('resize', () => {
      scenes[2].hotspots = getHotspots();
      updateScene();
    });

    window.addEventListener('wheel', (event) => {
      if (event.deltaY < 0) {
        advanceScene();
      } else if (event.deltaY > 0) {
        currentScene--;
        if (currentScene < 0) currentScene = scenes.length - 1;
        updateScene();
      }
    });

    window.onload = () => {
      updateScene();
      document.getElementById('radio').volume = 0.2;

      // Optional: close on Escape
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const popup = document.getElementById('popup');
          if (popup.style.display === 'flex') {
            closePopup({ currentTarget: popup, target: popup });
          }
        }
      });
    };
  </script>
</body>
</html>

