<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Underground Money Society</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üçÑ</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: black; font-family: 'Courier New', Courier, monospace; color: #ddd; }

    /* Scene container with fade */
    #scene { position: absolute; width: 100vw; height: 100vh; z-index: 1; overflow: hidden; opacity: 1; transition: opacity .28s ease; }
    #scene.scene-fade-out { opacity: 0; }
    #scene video, #scene-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; pointer-events: none; }
    .darken { filter: brightness(0.55); }

    /* Hotspots */
    .hotspot { position: absolute; width: 20px; height: 20px; border-radius: 50%; background: #fff; opacity: 0.6; z-index: 3; pointer-events: auto; transition: opacity 0.2s ease; border: none; }
    .hotspot:hover { animation: pulse 800ms infinite alternate ease-in-out; opacity: 1; }
    @keyframes pulse { from { box-shadow: 0 0 0 0 rgba(255,255,255,0.0); } to { box-shadow: 0 0 14px 2px rgba(255,255,255,0.9); } }
    .hotspot::after { content: attr(data-label); position: absolute; left: 50%; top: -10px; transform: translate(-50%, -100%); white-space: nowrap; background: rgba(0,0,0,0.8); color: #e6ffe6; font-size: 12px; padding: 6px 8px; border-radius: 6px; opacity: 0; pointer-events: none; transition: opacity .12s ease, transform .12s ease; }
    .hotspot:hover::after { opacity: 1; transform: translate(-50%, -100%) scale(1.05); }

    /* UI */
    #ui { position: absolute; top: 20px; left: 20px; z-index: 4; }
    .control-stack { display: flex; flex-direction: column; align-items: flex-start; } /* <‚Äî NEW: replaces inline style */
    .btn { padding: 8px 16px; font-size: 1em; background: rgba(255,255,255,0.1); border: 1px solid #888; color: white; cursor: pointer; margin: 6px; transition: 0.3s; }
    .btn:hover { background: rgba(255,255,255,0.3); }
    .btn.disabled { opacity: 0.3; pointer-events: none; }

    #dialogue { position: absolute; bottom: 30px; width: 100%; text-align: center; font-size: 1.2em; background: rgba(0,0,0,0.5); padding: 10px; z-index: 2; }

    /* Lore modal */
    #popup { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 10; }
    #popup video { width: 100%; height: 100%; object-fit: contain; outline: none; background: black; transform: scale(0.98); opacity: 0; transition: transform .18s ease-out, opacity .18s ease-out; }
    #popup.show video { transform: scale(1); opacity: 1; }
    #closeBtn { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; background: transparent; border: none; color: white; cursor: pointer; z-index: 11; }
    #closeBtn:hover { color: red; }

    /* Mobile landscape rotation for Scene 3 + side-by-side buttons */
    @media (max-width: 768px) and (orientation: landscape) {
      #scene-image.scene3-mobile {
        background-size: contain !important;
        transform: rotate(90deg);
        transform-origin: center center;
      }
      .hotspot.mobile-scene3 { transform: rotate(-90deg); }
      .hotspot[data-label="Lore"] { top: 60% !important; } /* move lower to avoid audio btn */
      #ui { top: auto; bottom: 20px; left: 20px; }
      .control-stack { flex-direction: row; align-items: center; gap: 8px; } /* <‚Äî NEW: buttons side-by-side in landscape */
    }

    /* Scene 3 mobile portrait ‚Äì swipe panorama scaffold */
    .pan-stage { position: absolute; inset: 0; overflow: hidden; touch-action: none; }
    .pan-surface { position: absolute; top: 0; left: 0; height: 100%; will-change: transform; touch-action: none; }
    .pan-img { position: absolute; top: 0; left: 0; height: 100%; width: auto; user-select: none; -webkit-user-drag: none; pointer-events: none; }
    .pan-surface .hotspot { pointer-events: auto; }

    /* Tap-to-Play overlay */
    #tapToPlay { display:none; position:absolute; inset:0; align-items:center; justify-content:center; z-index:12; background:rgba(0,0,0,0.45); }
    #tapToPlay button { font-size:18px; padding:12px 18px; border-radius:8px; border:1px solid #fff; background:rgba(255,255,255,0.12); color:#fff; }
  </style>
</head>
<body>
  <div id="scene"></div>

  <div id="ui">
    <div class="control-stack">
      <button id="advanceBtn" class="btn" onclick="advanceScene()">advance</button>
      <button class="btn" onclick="toggleAudio()">audio</button>
    </div>
  </div>

  <div id="dialogue">Private! Get ready. We're entering Sector 4.</div>

  <audio id="radio" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" autoplay loop></audio>

  <!-- Popup modal -->
  <div id="popup" onclick="closePopup(event)">
    <button id="closeBtn" onclick="closePopup(event)" aria-label="Close video">‚úï</button>
    <video id="popupVideo" controls playsinline webkit-playsinline muted autoplay preload="auto" crossorigin="anonymous"></video>
    <div id="tapToPlay"><button>Tap to Play ‚ñ∂</button></div>
  </div>

  <script>
    /* === CONFIG === */
    const LORE_SRC = "https://cryptopilot16.github.io/UMS/lore.mp4";

    const DEFAULT_LABELS = ['Twitter','Chart','Telegram','Community','Lore'];
    const HOTSPOT_LINKS = {
      'Twitter': 'https://x.com/UMSonSOL',
      'Chart': 'https://dexscreener.com/solana/ct9g9gddxwnvagvkjq9xoejvynpipr7uxx4akp6g8mhv',
      'Telegram': 'https://t.me/undergroundmoneysocietymemes',
      'Community': 'https://x.com/i/communities/1952904167753957408',
      'Lore': 'popup'
    };

    let scenes = [
      { background: 'scene1.mp4', type: 'video', class: 'darken', text: "Get ready. You're entering the Underground Money Society.", autoAdvance: true },
      { background: 'scene2.mp4', type: 'video', class: 'darken', text: 'The hardest degens of the Solana trenches', autoAdvance: true },
      { background: 'scene3.png', type: 'image', class: '', text: 'Wake up, join the underground: 9Z4EZGiirqkjE2Mfnb4xmJebxxqZZugTwewVRfo8bonk', labels: DEFAULT_LABELS, hotspots: getHotspots(), autoAdvance: false }
    ];
    let currentScene = 0;

    // Audio snapshot for Lore modal
    let _audioWasPlaying = false;

    // Scene 3 mobile portrait pan state
    let pan = { active: false, x: 0, startX: 0, minX: 0, maxX: 0, stageEl: null, surfaceEl: null, imgEl: null, listeners: [] };

    function isMobilePortrait() { return window.innerWidth <= 768 && window.matchMedia('(orientation: portrait)').matches; }
    function isMobileLandscape() { return window.innerWidth <= 768 && window.matchMedia('(orientation: landscape)').matches; }

    function getHotspots() {
      if (isMobileLandscape()) {
        return [
          { x: '60%', y: '18%' },
          { x: '74%', y: '20%' },
          { x: '98%', y: '40%' },
          { x: '44%', y: '40%' },
          { x: '12%', y: '25%' }
        ];
      }
      return [
        { x: '55%', y: '23%' },
        { x: '69%', y: '25%' },
        { x: '95%', y: '45%' },
        { x: '39%', y: '45%' },
        { x: '8%',  y: '30%' }
      ];
    }

    /* ========== Smooth scene transition helpers ========== */
    const FADE_MS = 280;
    function gotoScene(nextIndex) {
      if (nextIndex >= scenes.length) nextIndex = scenes.length - 1;
      if (nextIndex < 0) nextIndex = 0;
      if (nextIndex === currentScene) return;

      const sc = document.getElementById('scene');
      sc.classList.add('scene-fade-out');
      setTimeout(() => {
        currentScene = nextIndex;
        updateScene();
        requestAnimationFrame(() => sc.classList.remove('scene-fade-out'));
      }, FADE_MS);
    }

    function advanceScene() {
      if (currentScene === 2) return; // lock at end
      gotoScene(currentScene + 1);
    }

    /* ========== Render/update ========== */
    function updateScene() {
      teardownPanorama();
      const sceneContainer = document.getElementById('scene');
      sceneContainer.innerHTML = '';
      const current = scenes[currentScene];

      // Advance button lock on scene 3
      const advanceBtn = document.getElementById('advanceBtn');
      if (currentScene === 2) advanceBtn.classList.add('disabled');
      else advanceBtn.classList.remove('disabled');

      const isScene3 = current.background.includes('scene3');
      const rotateForMobile = isScene3 && isMobileLandscape();
      const panForMobile = isScene3 && isMobilePortrait();

      // === Scene content ===
      if (current.type === 'video') {
        const video = document.createElement('video');
        Object.assign(video, {
          src: current.background,
          autoplay: true,
          loop: false,
          muted: true,
          playsInline: true
        });
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.setAttribute('muted', '');
        if (current.class) video.className = current.class;
        sceneContainer.appendChild(video);

        const sceneIndexAtCreate = currentScene;
        const advanceIfCurrent = () => { if (currentScene === sceneIndexAtCreate) advanceScene(); };

        const tryPlay = () => video.play().catch(()=>{});
        tryPlay(); // immediate attempt
        video.addEventListener('canplay', tryPlay, { once: true });
        video.addEventListener('loadeddata', tryPlay, { once: true });
        video.addEventListener('loadedmetadata', tryPlay, { once: true });

        if (current.autoAdvance) {
          video.addEventListener('ended', advanceIfCurrent, { once: true });
          const onTimeUpdate = () => {
            if (video.duration && video.currentTime >= video.duration - 0.1) {
              video.removeEventListener('timeupdate', onTimeUpdate);
              advanceIfCurrent();
            }
          };
          video.addEventListener('timeupdate', onTimeUpdate);
        }

      } else if (isScene3 && panForMobile) {
        // Mobile portrait: swipe panorama with hotspots locked to the image
        const stage = document.createElement('div'); stage.className = 'pan-stage';
        const surface = document.createElement('div'); surface.className = 'pan-surface';
        const img = document.createElement('img'); img.className = 'pan-img'; img.src = current.background; img.alt = '';
        surface.appendChild(img);

        // Add hotspots INSIDE the surface so they move with the image
        const labels = current.labels || DEFAULT_LABELS;
        current.hotspots = getHotspots();
        (current.hotspots || []).forEach((hs, i) => {
          const dot = document.createElement('div');
          dot.className = 'hotspot';
          dot.style.left = hs.x;  // % of image width
          dot.style.top = hs.y;   // % of image height
          dot.setAttribute('data-label', labels[i] || '');
          dot.onclick = (ev) => { ev.stopPropagation(); handleHotspotClick(labels[i]); };
          surface.appendChild(dot);
        });

        stage.appendChild(surface);
        sceneContainer.appendChild(stage);
        img.addEventListener('load', () => setupPanorama(stage, surface, img));

      } else {
        // Desktop + mobile landscape
        const img = document.createElement('div');
        img.id = 'scene-image';
        img.style.background = `url('${current.background}') center/cover no-repeat`;
        if (rotateForMobile) img.className = 'scene3-mobile';
        if (current.class) img.classList.add(current.class);
        sceneContainer.appendChild(img);
      }

      // === Top-level hotspots (desktop + mobile landscape path) ===
      if (current.hotspots && (!isScene3 || !panForMobile)) {
        const labels = current.labels || DEFAULT_LABELS;
        current.hotspots.forEach((hs, i) => {
          const dot = document.createElement('div');
          dot.className = 'hotspot';
          if (rotateForMobile) dot.classList.add('mobile-scene3');
          dot.style.left = hs.x;
          dot.style.top = hs.y;
          dot.setAttribute('data-label', labels[i] || '');
          dot.onclick = () => handleHotspotClick(labels[i]);
          sceneContainer.appendChild(dot);
        });
      }

      document.getElementById('dialogue').textContent = current.text;
    }

    /* ========== Panorama (Scene 3 mobile portrait, drag only) ========== */
    function setupPanorama(stageEl, surfaceEl, imgEl) {
      pan.active = true;
      pan.stageEl = stageEl;
      pan.surfaceEl = surfaceEl;
      pan.imgEl = imgEl;

      const stageW = stageEl.clientWidth;
      const stageH = stageEl.clientHeight;
      const ar = imgEl.naturalWidth / imgEl.naturalHeight;

      // Ensure there is always something to pan: at least 1.5x viewport width
      const MIN_W_FACTOR = 1.5;
      const baseW = Math.round(stageH * ar);
      const imgW = Math.max(baseW, Math.round(stageW * MIN_W_FACTOR));

      imgEl.style.width = imgW + 'px';
      surfaceEl.style.width = imgW + 'px';

      // bounds: fully left = 0; fully right = stageW - imgW (<= 0)
      pan.maxX = 0;
      pan.minX = Math.min(0, stageW - imgW);

      // start perfectly centered (midpoint)
      pan.x = Math.round((pan.minX + pan.maxX) / 2);
      applyPan();

      // drag handlers (attach to the SURFACE so iOS allows preventDefault)
      const onDown = (e) => {
        const x = (e.touches ? e.touches[0].clientX : e.clientX);
        pan.startX = x - pan.x;
        pan.dragging = true;
        if (e.cancelable) e.preventDefault();
      };

      const onMove = (e) => {
        if (!pan.dragging) return;
        const x = (e.touches ? e.touches[0].clientX : e.clientX);
        pan.x = clamp(x - pan.startX, pan.minX, pan.maxX);
        applyPan();
        if (e.cancelable) e.preventDefault();
      };

      const onUp = () => { pan.dragging = false; };

      // IMPORTANT: passive:false so preventDefault works on iOS
      surfaceEl.addEventListener('touchstart', onDown, { passive: false });
      surfaceEl.addEventListener('touchmove',  onMove, { passive: false });
      surfaceEl.addEventListener('touchend',   onUp,   { passive: true  });

      surfaceEl.addEventListener('mousedown', (e) => { e.preventDefault(); onDown(e); }, { passive: false });
      window.addEventListener('mousemove', onMove, { passive: false });
      window.addEventListener('mouseup',   onUp,   { passive: true  });

      // store exact fns/targets so teardown can remove them
      pan.listeners = [
        ['touchstart', onDown, surfaceEl],
        ['touchmove',  onMove, surfaceEl],
        ['touchend',   onUp,   surfaceEl],
        ['mousedown',  onDown, surfaceEl],
        ['mousemove',  onMove, window],
        ['mouseup',    onUp,   window],
      ];
    }

    function applyPan() { if (pan.surfaceEl) pan.surfaceEl.style.transform = `translate3d(${pan.x}px,0,0)`; }
    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function teardownPanorama() {
      if (!pan.active) return;
      pan.listeners.forEach(([type, fn, target]) => {
        target.removeEventListener(type, fn);
      });
      pan = { active: false, x: 0, startX: 0, minX: 0, maxX: 0, stageEl: null, surfaceEl: null, imgEl: null, listeners: [] };
    }

    /* ========== Lore modal (mobile-safe playback) ========== */
    function restoreAudio() {
      const audio = document.getElementById('radio');
      if (_audioWasPlaying) audio.play().catch(()=>{});
      else { try { audio.pause(); } catch {} }
    }

    function handleHotspotClick(label) {
      const link = HOTSPOT_LINKS[label];
      if (link === 'popup') {
        const popup = document.getElementById('popup');
        const video = document.getElementById('popupVideo');
        const audio = document.getElementById('radio');
        const tapOverlay = document.getElementById('tapToPlay');

        _audioWasPlaying = !audio.paused;
        try { audio.pause(); } catch {}

        // Prep for iOS: inline, muted, autoplay-friendly
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.setAttribute('muted', '');
        video.muted = true;
        video.preload = 'auto';
        video.src = LORE_SRC;
        video.currentTime = 0;

        // show popup and try to play immediately (same gesture)
        popup.style.display = 'flex';
        popup.classList.add('show');

        video.play()
          .then(() => { tapOverlay.style.display = 'none'; })
          .catch(() => { tapOverlay.style.display = 'flex'; });

        const startWithSound = (e) => {
          e.stopPropagation();
          tapOverlay.style.display = 'none';
          video.muted = false;
          video.removeAttribute('muted');
          video.play().catch(()=>{});
        };
        tapOverlay.onclick = startWithSound;
        tapOverlay.addEventListener('touchend', startWithSound);

        video.addEventListener('play', () => { tapOverlay.style.display = 'none'; }, { once: true });
        video.onerror = () => console.error('Lore video failed to load. Check URL/MIME/CORS.');

        const onDone = () => restoreAudio();
        video.onended = onDone;
        video.onemptied = onDone;

      } else if (link) {
        window.open(link, '_blank');
      }
    }

    function closePopup(e) {
      const isBackdrop = e && e.currentTarget && e.target === e.currentTarget;
      const isCloseBtn = e && e.target && e.target.id === 'closeBtn';
      if (!isBackdrop && !isCloseBtn) return;

      const popup = document.getElementById('popup');
      const video = document.getElementById('popupVideo');
      const tapOverlay = document.getElementById('tapToPlay');

      try { video.pause(); } catch {}
      popup.classList.remove('show');
      popup.style.display = 'none';

      video.removeAttribute('src');
      video.load();

      if (tapOverlay) tapOverlay.style.display = 'none';

      restoreAudio();
    }

    function toggleAudio() {
      const audio = document.getElementById('radio');
      if (audio.paused) { audio.currentTime = 0; audio.play(); } else { audio.pause(); }
    }

    /* ========== Global listeners ========== */
    window.addEventListener('resize', () => {
      scenes[2].hotspots = getHotspots();
      updateScene();
    });

    // Block wheel at Scene 3 (end)
    window.addEventListener('wheel', (event) => {
      if (currentScene === 2) return;
      if (event.deltaY < 0) advanceScene();
      else if (event.deltaY > 0) {
        gotoScene(currentScene - 1);
      }
    });

    window.onload = () => {
      updateScene();
      document.getElementById('radio').volume = 0.2;
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const popup = document.getElementById('popup');
          if (popup.style.display === 'flex') {
            closePopup({ currentTarget: popup, target: popup });
          }
        }
      });
    };
  </script>
</body>
</html>
